var App=App||function(){var a=require("is-online"),b=require("fs"),c=require("crypto"),d=(require("nw.gui"),"aes-256-ctr"),e="http://192.168.1.37/",f="/Users/chrisnewton/Movies/",g="",h=[],i=function(){k(new DownloadViewController)},j=function(a,c){b.readFile(a,"utf8",function(a,b){if(a)c(a,null);else{var d=new DOMParser,e=d.parseFromString(b,"text/html"),f=e.body.children[0];c(null,f)}})},k=function(a,b,c){j(a.viewContentPath,function(d,e){if(d)console.log("Error loading viewContent");else{var f=c?c:{},g=document.querySelector(".viewContent");if(g){var i=h.pop();f.previousViewControllerName=i.viewControllerName,g.style.transform=b?"translateX("+window.innerWidth+"px)":"scale(0.8)",g.addEventListener("transitionend",function j(){document.body.removeChild(g),i.destroy(),i=null,g.removeEventListener("transitionend",j,!1)},!1),document.body.appendChild(e),b&&(e.style.zIndex="-1"),e.style.transform=b?"scale(0.8)":"translateX("+window.innerWidth+"px)",e.addEventListener("transitionend",function k(){h.push(a),a.create(f),e.removeEventListener("transitionend",k,!1)},!1),e.offsetWidth,e.style.transform=b?"scale(1.0)":"translateX(0px)"}else document.body.appendChild(e),h.push(a),a.create(f)}})},l=function(b){a(b)},m=function(a){var b=localStorage.getItem(a);if(""==b||void 0==b)return b;try{b=p(b)}catch(c){console.log("DECRYPT ERROR")}return b},n=function(a,b){var c=""==b?b:o(b);localStorage.setItem(a,c)},o=function(a){var b=c.createCipher(d,AppConstants.localEncryptionKey),e=b.update(a,"utf8","hex");return e+=b["final"]("hex")},p=function(a){var b=c.createDecipher(d,AppConstants.localEncryptionKey),e=b.update(a,"hex","utf8");return e+=b["final"]("utf8")},q=function(a,c){var d;b.exists(a,function(e){e?b.readFile(a,function(b,e){if(b)d={status:a+" : Error reading json from disk"},c(d,null);else{var f;try{f=JSON.parse(e),c(null,f)}catch(g){d={status:a+" : Error parsing json"},c(d,null)}}}):c(null,null)})};return window.addEventListener("load",i,!1),{serverUrl:e,downloadFolder:f,mediaFolder:g,isNetworkConnected:l,startViewController:k,getItemFromStorage:m,setItemToStorage:n,readJsonFromDisk:q}}(),gui=require("nw.gui"),win=gui.Window.get(),menubar=new gui.Menu({type:"menubar"});"darwin"===process.platform&&menubar.createMacBuiltin(gui.App.manifest.description),win.menu=menubar;var FileDownloader=FileDownloader||function(a,b,c,d,e){function f(){a.targetPath=b;var f=a.mediaurl;l=m({method:"GET",uri:f,headers:{Range:"bytes="+q+"-"}}),l.pipe(k),l.on("response",function(c){console.log(c);var d=c.headers["content-type"];if(console.log(d),"Not Found"==c.statusMessage){var f={message:"Not Found"};return e(f,a),s=!0,n.unlink(b),void l.abort()}var g=c.headers["content-length"],k=c.headers["content-range"];!g&&k?h=parseInt(c.headers["content-range"].split("/")[1],10):g&&(h=parseInt(c.headers["content-length"],10)),console.log(h),i=0,j=h/o,isNaN(h)&&(r=!0,l.abort())}),l.on("data",function(b){if(t)u+=b;else{i+=b.length;var d=i/o,e=0===q?d:q/o+d,f=0===q?j:q/o+j;c(Math.floor(e),Math.floor(f),a.title)}}),l.on("end",function(){var b=null,c="File downloaded successfully";if(r)console.log("FileDownloader: File already Downloaded"),c="File already Downloaded";else{if(s)return;p?b={message:"paused"}:t&&(b={message:u},console.log(u))}d(a,c,b)}),l.on("error",function(b){console.log(b),e(b,a)})}function g(){p=!0,l.abort()}var h,i,j,k,l,m=require("request"),n=require("fs"),o=1048576,p=!1,q=0,r=!1,s=!1,t=!1,u="";return n.stat(b,function(a,c){a?(k=n.createWriteStream(b),f()):(q=c.size,k=n.createWriteStream(b,{flags:"a"}),f())}),console.log("url = "+a.mediaurl),{cancel:g}},VideoConverter=VideoConverter||function(a,b,c,d,e,f){var g=require("handbrake-js"),h={input:a,output:b,preset:"Normal",rate:25};console.log("definition = "+c),"SD"==c&&(h.width=1024),g.spawn(h).on("error",function(a){f(a)}).on("progress",function(a){console.log("Percent complete: %s, ETA: %s",a.percentComplete,a.eta),d(a)}).on("end",function(){}).on("complete",function(){e()})},DownloadViewController=DownloadViewController||function(){var a,b,c,d,e,f,g,h="./app-data/download.html",i="DownloadViewController",j=require("request"),k=require("fs"),l=require("nw.gui"),m=l.App.dataPath+"/",n="urls.json",o="/browse/index.jim?dir=/media/My%20Video/aaa_server",p=0,q=0,r=0,s=0,t=3e3,u=function(b){a=b?b.previousViewControllerName:null,c=document.querySelector("#mediaList");var d=document.querySelector("#ipAddress"),e=document.querySelector("#tsFolderLocation"),h=document.querySelector("#mp4FolderLocation"),i=document.querySelector("#stopButton");f=document.querySelector("#startButton"),d.value=localStorage.getItem("ipaddress"),e.value=localStorage.getItem("tsFolderPath"),h.value=localStorage.getItem("mp4FolderPath"),i.addEventListener("click",function(){clearTimeout(g),f.disabled=!1},!1),f.addEventListener("click",function(){f.disabled=!0,localStorage.setItem("ipaddress",d.value),localStorage.setItem("tsFolderPath",e.value),localStorage.setItem("mp4FolderPath",h.value),App.serverUrl=d.value,App.downloadFolder=e.value,App.mediaFolder=h.value,v()},!1)},v=function(){App.readJsonFromDisk(m+n,function(a,h){a?console.log(a.status):(h?b=h:(console.log("File does not exist"),b=null),x(function(a,h){if(a)console.log("Error Connecting to Server = "+a),c.innerHTML="Error Connecting to Server",f.disabled&&(g=setTimeout(v,t));else if(b){var i=b.urls,j=h.urls;D(i,j,function(a,h){if(0==a.length&&0==h.length)console.log("No Changes on Server"),c.innerHTML="No Changes on Server",f.disabled&&(g=setTimeout(v,t));else{if(h.length>0){console.log("deleteArray = ",h);for(var i=0;i<h.length;i++){var j=h[i].mediaurl.split("/")[6];try{k.unlinkSync(h[i].localFile),E(b.urls,h[i].mediaurl)}catch(l){E(b.urls,h[i].mediaurl),console.log("couldn't find file "+m+j+" but deleted it from json anyway")}}w(b),f.disabled&&(g=setTimeout(v,t))}a.length>0&&(p=a.length,d=a,q=0,s=0,e=null,y())}})}else p=h.urls.length,d=h.urls,q=0,s=0,e=null,y()}))})},w=function(a){var b=JSON.stringify(a),c=m+n;k.writeFile(c,b,function(a){a?console.log(a):console.log("JSON saved to "+c)})},x=function(a){console.log(App.serverUrl+o),j(App.serverUrl+o,function(b,c,d){if(b||200!=c.statusCode)b&&(console.log(b),a(b,null));else{console.log(c.body);var e=new DOMParser,f=e.parseFromString(c.body,"text/html"),g=f.body,h=g.querySelectorAll("fieldset.cleft div.va.bf"),i={};i.urls=[];for(var k=h.length,l=0,m=0;m<h.length;m++){var n=h[m].querySelector("a.bf"),o=n.getAttribute("file"),p=n.getAttribute("type"),q=App.serverUrl+"browse/file.jim?file="+o+"&type="+p;console.log("fileUrl = "+q),j(q,function(b,c,d){if(b||200!=c.statusCode)b&&k--;else{l++;for(var f=e.parseFromString(c.body,"text/html"),g=f.body,h=g.querySelector("a").href,j=decodeURI(g.querySelector(".bmp.va").getAttribute("src").split("/")[4]),m="",n="",o=g.querySelectorAll("th"),p=0;p<o.length;p++){var q=o[p].innerHTML;"synopsis"==q.toLowerCase()&&(m=o[p].parentNode.children[1].innerHTML),"flags"==q.toLowerCase()&&(n=o[p].parentNode.children[1].innerHTML.substring(0,2))}i.urls.push({mediaurl:h,title:j,desc:m,definition:n}),l==k&&a(null,i)}})}console.log(i)}})},y=function(){console.log("noOfMediaFilesDownloaded ",q),console.log("totalMediaFilesToDownload ",p);for(var a=0;a<d.length;a++){var b=document.createElement("li");b.urlObj=d[a];var e=d[a].title,f=document.createElement("p");f.innerHTML=e,f.setAttribute("class","mediaLabel");var g=document.createElement("p");g.setAttribute("class","progLabel"),g.innerHTML="";var h=document.createElement("progress");h.max="100",h.value="0",b.appendChild(f),b.appendChild(g),b.appendChild(h),c.appendChild(b)}var e=d[q].title;z(d[q],App.downloadFolder+e,B,C,A)},z=function(a,b,c,d,e){new FileDownloader(a,b,c,d,e)},A=function(a,b){console.log("Download Error ",a);for(var d=0;d<c.children.length;d++)c.children[d].urlObj.title===b.title&&(c.children[d].children[1].innerHTML="File not found on server");p--},B=function(a,b,d){for(var e=a+"mb / "+b+"mb",f=a/b*100,g=0;g<c.children.length;g++)c.children[g].urlObj.title===d&&(c.children[g].children[1].innerHTML=e+"  "+Math.floor(f)+"%",c.children[g].children[2].value=f)},C=function(a,f,g){if(console.log(g),g&&"paused"!=g.message);else{if(g&&"paused"==g.message)return;b||(b={},b.urls=[]),e||(e={},e.urls=[]),b.urls.push({mediaurl:a.mediaurl,title:a.title,desc:a.desc,localFile:a.targetPath,definition:a.definition}),e.urls.push({mediaurl:a.mediaurl,title:a.title,desc:a.desc,localFile:a.targetPath,definition:a.definition}),w(b),q++;for(var h=0;h<c.children.length;h++)c.children[h].urlObj.title===a.title&&(c.children[h].classList.add("dlComplete"),c.children[h].children[1].innerHTML=f);if(q===p)r=e.urls.length,F(e.urls[s].localFile,App.mediaFolder+e.urls[s].title+".mp4",e.urls[s].definition);else{var i=d[q].title;z(d[q],App.downloadFolder+i,B,C,A)}}},D=function(a,b,c){var d,e;a.length>b.length?(d=a,e=b):b.length>a.length?(d=b,e=a):(d=a,e=b);for(var f=a.slice(0),g=b.slice(0),h=0;h<d.length;h++)for(var i=0;i<e.length;i++){var j=d[h],k=e[i];if(j.mediaurl===k.mediaurl){console.log("match = ",j.mediaurl),E(f,j.mediaurl),E(g,j.mediaurl);break}}console.log("deleteIssuesArr = ",f),console.log("addIssuesArr = ",g),c(g,f)},E=function(a,b){for(var c=0;c<a.length;c++)a[c].mediaurl===b&&a.splice(c,1)},F=function(a,b,c){new VideoConverter(a,b,c,H,I,G)},G=function(a){console.log("error = "+a)},H=function(a){for(var b=e.urls[s].title,d=0;d<c.children.length;d++)c.children[d].urlObj.title===b&&(c.children[d].children[1].innerHTML="Converting to mp4:  "+Math.floor(a.percentComplete)+"%, ETA: "+a.eta,c.children[d].children[2].value=a.percentComplete)},I=function(){console.log("conversion Complete");for(var a=e.urls[s].title,b=0;b<c.children.length;b++)c.children[b].urlObj.title===a&&(c.children[b].classList.add("convComplete"),c.children[b].children[1].innerHTML="File Downloaded & Converted");s++,s==r?(console.log("----~ ALL conversions Complete ~-----"),f.disabled&&(g=setTimeout(v,t))):F(e.urls[s].localFile,App.mediaFolder+e.urls[s].title+".mp4",e.urls[s].definition)},J=function(){};return{viewContentPath:h,viewControllerName:i,create:u,destroy:J}},ViewController=ViewController||function(){var a,b="./app-data/<path>.html",c="ViewController",d=function(b){a=b?b.previousViewControllerName:null},e=function(){};return{viewContentPath:b,viewControllerName:c,create:d,destroy:e}};