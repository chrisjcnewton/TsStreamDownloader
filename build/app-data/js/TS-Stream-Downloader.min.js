var App=App||function(){var a=require("is-online"),b=require("fs"),c=require("crypto"),d=(require("nw.gui"),"aes-256-ctr"),e="http://localhost:8888/DLNA-SERVER/endpoint.html",f=[],g=function(){i(new DownloadViewController)},h=function(a,c){b.readFile(a,"utf8",function(a,b){if(a)c(a,null);else{var d=new DOMParser,e=d.parseFromString(b,"text/html"),f=e.body.children[0];c(null,f)}})},i=function(a,b,c){h(a.viewContentPath,function(d,e){if(d)console.log("Error loading viewContent");else{var g=c?c:{},h=document.querySelector(".viewContent");if(h){var i=f.pop();g.previousViewControllerName=i.viewControllerName,h.style.transform=b?"translateX("+window.innerWidth+"px)":"scale(0.8)",h.addEventListener("transitionend",function j(){document.body.removeChild(h),i.destroy(),i=null,h.removeEventListener("transitionend",j,!1)},!1),document.body.appendChild(e),b&&(e.style.zIndex="-1"),e.style.transform=b?"scale(0.8)":"translateX("+window.innerWidth+"px)",e.addEventListener("transitionend",function k(){f.push(a),a.create(g),e.removeEventListener("transitionend",k,!1)},!1),e.offsetWidth,e.style.transform=b?"scale(1.0)":"translateX(0px)"}else document.body.appendChild(e),f.push(a),a.create(g)}})},j=function(b){a(b)},k=function(a){var b=localStorage.getItem(a);if(""==b||void 0==b)return b;try{b=n(b)}catch(c){console.log("DECRYPT ERROR")}return b},l=function(a,b){var c=""==b?b:m(b);localStorage.setItem(a,c)},m=function(a){var b=c.createCipher(d,AppConstants.localEncryptionKey),e=b.update(a,"utf8","hex");return e+=b["final"]("hex")},n=function(a){var b=c.createDecipher(d,AppConstants.localEncryptionKey),e=b.update(a,"hex","utf8");return e+=b["final"]("utf8")},o=function(a,c){var d;b.exists(a,function(e){e?b.readFile(a,function(b,e){if(b)d={status:a+" : Error reading json from disk"},c(d,null);else{var f;try{f=JSON.parse(e),c(null,f)}catch(g){d={status:a+" : Error parsing json"},c(d,null)}}}):c(null,null)})};return window.addEventListener("load",g,!1),{serverUrl:e,isNetworkConnected:j,startViewController:i,getItemFromStorage:k,setItemToStorage:l,readJsonFromDisk:o}}(),gui=require("nw.gui"),win=gui.Window.get(),menubar=new gui.Menu({type:"menubar"});"darwin"===process.platform;var fileMenu=new gui.Menu;fileMenu.append(new gui.MenuItem({type:"normal",label:"Check for new content",click:function(){gui.Window.get().close(!0)}})),fileMenu.append(new gui.MenuItem({type:"separator"})),fileMenu.append(new gui.MenuItem({type:"normal",label:"Exit",click:function(){gui.Window.get().close(!0)}})),menubar.append(new gui.MenuItem({label:"File",submenu:fileMenu})),win.menu=menubar;var AppUpdater=AppUpdater||function(a){var b,c,d,e,f=require("request"),g=require("fs"),h=require("semver"),i=require("ncp").ncp,j=require("nw.gui"),k=require("rimraf"),l=require("mkdirp"),m=a.zipName,n=a.srcFolderName,o=a.destFolderName,p=j.App.dataPath+"/",q="No Update Available",r="Update Available",s="Update Successful",t=!1,u=!1,v=!1,w=!1,x=!1,y=function(a){c=a;var b=j.App.manifest.version,d=j.App.manifest.updateUrl;f(d,function(a,d,f){a||200!=d.statusCode?a&&c(null,a):(e=JSON.parse(f),h.gt(e.version,b)?c(r,null):c(q,null))})},z=function(){x=!0,C(e.updateContentsZip,"The Knowledge Version "+e.version+" is available.<br>Would you like to update the App?",!0)},A=function(a,b,d){x=!1,c=d,C(a,b,!0)},B=function(a,b,d){x=!1,c=d,C(a,b,!1,"DOWNLOAD")},C=function(a,e,f,g){b=new Dialog(e,{confirmCopy:g?g:"OK",cancelCopy:"Cancel",showConfirm:!0,showCancel:f,showProgress:!1},function(e){e&&!t||e&&t&&u?(t=!0,b.toggleProgress(),b.toggleConfirmButton(),b.updateMessage("DOWNLOADING CONTENT"),f&&b.toggleCancelButton(),d&&(d=null),d=new FileDownloader(a,p+m,E,F,D)):e&&t&&!u&&!v&&w?(console.log("Restart App"),x?j.App.quit():(b.hide(),b=null,c(s,null))):(!e||e&&v)&&(b.hide(),b=null,c(q,null))},function(b){b?d.cancel():(d&&(d=null),d=new FileDownloader(a,p+m,E,F,D))})},D=function(a){u=!0,b.updateMessage("There was a problem downloading the update.<br>("+a.message+")<br>Would you like to try again?"),b.toggleProgress(),b.toggleCancelButton(),b.toggleConfirmButton(),b.updateConfirmCopy("Try Again")},E=function(a,c){var d=a+"mb / "+c+"mb";b.updateProgressMessage(d);var e=a/c*100;b.updateProgress(e)},F=function(a,c){if(console.log(c),c&&"paused"!=c.message)u=!0,b.toggleProgress(),b.toggleCancelButton(),b.updateMessage(c.message);else{if(c&&"paused"==c.message)return;u=!1,b.updateProgress("indeterminate"),b.updateProgressMessage(""),b.updateMessage("UNZIPPING CONTENT"),b.toggleResumePauseButton(),g.exists(p+n,function(c){c||g.mkdirSync(p+n),new UnzipFile(a.path,p+n,G,function(a){v=!0,b.updateMessage("There was a problem unzipping the update.<br>("+a.message+")<br>Please try again later"),b.toggleProgress(),b.toggleConfirmButton(),g.unlink(p+m,function(a){if(a)throw a;console.log("successfully deleted zip")})})})}},G=function(){console.log("====== _onFilesUnzipped called"),i.limit=16,g.exists(o,function(a){a||l.sync(o),i(p+n,o,function(a){a?console.log("copy files error = "+a):(console.log("Files Copied!"),g.unlink(p+m,function(a){return a?void console.log("delete zip error: "+a):(console.log("successfully deleted update.zip"),void k(p+n,function(a){if(a)console.log("rimraf error: "+a);else{w=!0,console.log("Folder deleted "+n);var c=x?"The Knowledge App has been updated<br>Click Close App and restart.":"The content has been installed";b.updateMessage(c),b.toggleProgress(),b.updateConfirmCopy("OK"),b.toggleConfirmButton(),x&&b.updateConfirmCopy("Close App")}}))}))})})};return{checkForAppUpdate:y,downloadAppUpdate:z,downloadContentUpdate:A,downloadInitialContent:B,NO_UPDATE:q,UPDATE_AVAILABLE:r,UPDATE_SUCCESSFUL:s}},FileDownloader=FileDownloader||function(a,b,c,d,e){function f(){k.remoteUrl=a;var b=a;l=m({method:"GET",uri:b,headers:{Range:"bytes="+q+"-"}}),l.pipe(k),l.on("response",function(a){console.log(a);var b=a.headers["content-type"];console.log(b),"application/octet-stream"==b&&"application/zip"==b||"text/html"!=b||(s=!0),h=parseInt(a.headers["content-length"],10),i=0,j=h/o,isNaN(h)&&(r=!0,l.abort())}),l.on("data",function(a){if(s)t+=a;else{i+=a.length;var b=i/o,d=0===q?b:q/o+b,e=0===q?j:q/o+j;c(Math.floor(d),Math.floor(e))}}),l.on("end",function(){var a=null;r?console.log("FileDownloader: File already Downloaded"):p?a={message:"paused"}:s&&(a={message:t},console.log(t)),d(k,a)}),l.on("error",function(a){console.log(a),e(a)})}function g(){p=!0,l.abort()}var h,i,j,k,l,m=require("request"),n=require("fs"),o=1048576,p=!1,q=0,r=!1,s=!1,t="";return n.stat(b,function(a,c){a?(k=n.createWriteStream(b),f()):(q=c.size,k=n.createWriteStream(b,{flags:"a"}),f())}),console.log("url = "+a),{cancel:g}},AppContentViewController=AppContentViewController||function(){var a,b,c,d,e,f,g,h,i,j="./app-data/appContent.html",k="AppContentViewController",l=require("request"),m=require("fs"),n=require("nw.gui"),o=DHLApp.serverBaseUrl+DHLApp.issuesJsonUrl,p=function(c){a=c?c.previousViewControllerName:null,b=document.querySelector("#contentIFrame"),window.addEventListener("resize",E,!1),q()},q=function(){DHLApp.readJsonFromDisk(DHLApp.appContentDataPath+DHLApp.menuJsonName,function(a,b){if(a)console.log(a.status);else if(b){var c=document.querySelector("#mainContentMenu #knowledgeLogo");c.onclick=function(){y(),z(),g&&(g.innerHTML=""),A(DHLApp.appContentDataPath+b.landing)},r(b),A(DHLApp.appContentDataPath+b.landing)}else console.log("File does not exist"),DHLApp.startViewController(new ContentDownloadViewController)})},r=function(a){h=a,e=document.querySelector("#mainContentMenu #searchBox"),f=document.querySelector("#searchResults"),f.addEventListener("transitionend",J,!1);var b=document.querySelector("#searchResults #searchCloseButton");b.onclick=I,e.addEventListener("keyup",H,!1),d=new SearchIndexBuilder,d.updateIndex(DHLApp.appContentDataPath+"searchIndex.json");var i=document.querySelector("#mainContentMenu #topLevelNav");c=document.querySelector("#mainContentMenu #subLevelNav"),g=document.querySelector("#breadcrumbs");for(var j=h.sections,k=0;k<j.length;k++){var l=document.createElement("li");j[k].hasOwnProperty("pages")?(l.onclick=s,l.pages=j[k].pages):l.onclick=u,l.innerHTML=j[k].title,l.menuObj=j[k],i.appendChild(l)}var m=document.querySelector("#mainContentMenu");m.classList.add("show"),f.classList.add("show")},s=function(a){var b=this;b.classList.contains("highlighted")?u.call(b,a):v.call(b,a)},t=function(a,b){b.setAttribute("class","subItemList");for(var d=0;d<a.length;d++)if(a[d].hasOwnProperty("pages")){var e=document.createElement("li");e.setAttribute("class","subNavTitleItem"),e.menuObj=a[d],e.onclick=u,e.innerHTML=a[d].title;var f=document.createElement("span");f.appendChild(e),t(a[d].pages,f)}else{var g=document.createElement("li");g.setAttribute("class","subLevelLink"),g.innerHTML=a[d].title,g.menuObj=a[d],g.onclick=u,b.appendChild(g)}c.appendChild(b)},u=function(){var a=this;A(DHLApp.appContentDataPath+a.menuObj.path);var b=K(h.sections,{},a.menuObj.path);g.innerHTML="";for(var c=0;c<b.length;c++){var d=b[c].title,e=document.createElement("div");if(e.setAttribute("class","breadcrumb"),e.innerHTML=d,e.menuObj=b[c],b[c].path&&c!=b.length-1&&(e.onclick=u,e.style.cursor="pointer"),g.appendChild(e),c!=b.length-1){var f=document.createElement("span");f.innerHTML=" > ",g.appendChild(f)}}w()},v=function(a){y(),z();var b=document.createElement("span");t(a.target.pages,b);var d=new Image;d.classList.add("subLevelNavClose"),d.src="images/close-button.png",d.onclick=w,c.appendChild(d);var e=document.createElement("div");e.style.clear="both",c.appendChild(e),a.target.classList.add("highlighted"),c.classList.add("show")},w=function(){var a=document.querySelectorAll("#topLevelNav li"),b=g.innerHTML.toUpperCase();if(y(),""!=b)for(var c=b.split(" &GT; ")[0],d=0;d<a.length;d++)c==a[d].innerHTML.toUpperCase()&&a[d].classList.add("currentActive")},x=function(){for(var a=document.querySelectorAll("#topLevelNav li"),b=0;b<a.length;b++)a[b].classList.remove("highlighted"),a[b].classList.remove("currentActive")},y=function(){x(),c.style.transition="none",c.classList.remove("show"),c.offsetHeight,c.style.transition="opacity 0.3s ease-in-out"},z=function(){c.innerHTML=""},A=function(a){b.onload=B,b.style.transition="none",b.style.opacity="0",b.offsetHeight,b.style.transition="opacity 0.6s ease-in-out",b.src=a},B=function(){for(var a=b.contentWindow.document.querySelectorAll("a"),c=0;c<a.length;c++)a[c].hasAttribute("href")&&(a[c].onclick=D),a[c].style.outline="none";b.contentWindow.document.body.style.overflow="hidden";var d=b.contentWindow.document.querySelector("section"),e=document.querySelector(".appContentView");void 0!=d.getAttribute("data-bg")?(e.style.backgroundColor="black",g.classList.add("white")):(e.style.backgroundColor="white",g.classList.remove("white"));var f=b.contentWindow.document.querySelector(".version-content");f&&F(function(a){f.children[0].children[0].innerHTML+=a.remoteDate?" "+a.remoteDate:" Server not available",f.children[1].children[0].innerHTML+=" "+a.localDate});var h=b.contentWindow.document.querySelectorAll(".springboard-accordion");if(h)for(var i=0;i<h.length;i++)h[i].addEventListener("click",C,!1);E(),b.style.opacity="1"},C=function(){console.log("acc clicked"),setTimeout(E,100)},D=function(a){a.preventDefault();var b=this.href,c=this.protocol;if(console.log("protocol = "+c),console.log("this.protocol = "+this.protocol),console.log("this.hostname = "+this.hostname),console.log("this.pathname = "+this.pathname),"update:"===c)F();else if("http:"===c||"https:"===c)n.Shell.openExternal(b);else if("tablet:"===c){console.log(h);var d=this.pathname.substring(1);console.log("internalPath = "+d),console.log("menuJsonObj = "+h.sections);var e=L(h.sections,d);console.log("pagePath = "+e);var f={};f.menuObj={},f.menuObj.path=e,u.call(f,null)}},E=function(){clearTimeout(i),i=setTimeout(function(){b&&(b.style.height="1px",b.style.offsetHeight,b.style.height=b.contentWindow.document.body.scrollHeight+"px")},100)},F=function(a){DHLApp.readJsonFromDisk(DHLApp.appDataPath+DHLApp.updateJsonName,function(b,c){if(b)console.log(b.status);else if(c){var d=c;l(DHLApp.addSecurityQueryString(o),function(b,c,e){if(b)if(a){var f={};f.localDate=DHLApp.convertTimestampToDate(d.items[0].date),f.remoteDate=null,a(f)}else var g=new Dialog("Can't connect to server, check your internet connection",{confirmCopy:"OK"},function(){g.hide(),g=null});else{var h=JSON.parse(e);if(a){var f={};f.localDate=DHLApp.convertTimestampToDate(d.items[0].date),f.remoteDate=DHLApp.convertTimestampToDate(h.items[0].date),a(f)}else if(h.items[0].date!==d.items[0].date){console.log("An update is available");var i=h.items[0].issueurl;G(i,e)}else{console.log("NO update available");var j=new Dialog("Your content is up to date",{confirmCopy:"OK"},function(){j.hide(),j=null})}}})}})},G=function(a,b,c){console.log("download this file "+a);var d;d=c?c:"An update to the DHL Knowledge Content is available.<br>Click OK to update";var e=new AppUpdater({zipName:"content_update.zip",srcFolderName:"content_update",destFolderName:DHLApp.appContentDataPath});e.downloadContentUpdate(a,d,function(a,c){c||(a===e.UPDATE_SUCCESSFUL?(console.log(e.UPDATE_SUCCESSFUL),m.exists(DHLApp.appDataPath,function(a){a||m.mkdirSync(DHLApp.appDataPath),m.writeFile(DHLApp.appDataPath+DHLApp.updateJsonName,b,"utf-8",function(a){a&&console.log("Error writing json to disk")})}),DHLApp.startViewController(new AppContentViewController)):a===e.NO_UPDATE&&console.log(e.NO_UPDATE))})},H=function(){var a=d.search(e.value),b=document.querySelector("#searchResults ul"),c=document.querySelector("#searchResults #searchTitle");if(a.length>0){c.innerHTML=a.length+" Result(s)",f.style.display="block",f.offsetHeight,f.classList.add("expand"),b.innerHTML="";for(var g=0;g<a.length;g++){var i=document.createElement("li"),j=K(h.sections,{},a[g].path);if(j.length>0){for(var k="",l=0;l<j.length;l++)k+=l==j.length-1?j[l].title:j[l].title+" > ";i.innerHTML="<span class='searchBreadCrumb'>"+k+"</span><br><span class='searchResultTitle'>"+a[g].title+"</span>"}else i.innerHTML=a[g].title;i.menuObj=a[g],i.onclick=function(a){u.call(this,a)},b.appendChild(i)}}else f.classList.remove("expand")},I=function(){f.classList.remove("expand")},J=function(){f.classList.contains("expand")||(f.style.display="none")},K=function(a,b,c){for(var d=0;d<a.length;d++){if(a[d].path===c){var e=[];return b&&b.pObj&&b.pObj.title&&e.push(b.pObj),b&&b.title&&e.push(b),e.push(a[d]),e}if(a[d].hasOwnProperty("pages")){a[d].pObj=b;var f=K(a[d].pages,a[d],c);if(f)return f}}return!1},L=function(a,b){for(var c=0;c<a.length;c++){if(a[c]["original-path"]===b)return a[c].path;if(a[c].hasOwnProperty("pages")){var d=L(a[c].pages,b);if(d)return d}}return!1},M=function(){window.removeEventListener("resize",E,!1),f&&f.removeEventListener("transitionend",J,!1),e&&e.removeEventListener("keyup",H,!1)};return{viewContentPath:j,viewControllerName:k,create:p,destroy:M}},DownloadViewController=DownloadViewController||function(){var a,b,c="./app-data/download.html",d="DownloadViewController",e=require("request"),f=require("fs"),g=require("nw.gui"),h=g.App.dataPath+"/",i="urls.json",j=function(b){a=b?b.previousViewControllerName:null,k()},k=function(){App.readJsonFromDisk(h+i,function(a,c){a?console.log(a.status):(c?b=c:(console.log("File does not exist"),b=null),m(function(a,c){if(a)console.log("Error Connecting to Server = "+a);else if(b){var d=b.urls,e=c.urls;r(d,e,function(a,c){if(0==a.length&&0==c.length)console.log("No Changes on Server");else{if(c.length>0){console.log("deleteArray = ",c);for(var d=0;d<c.length;d++){var e=c[d].mediaurl.split("/")[4];try{f.unlinkSync(h+e),s(b.urls,c[d].mediaurl)}catch(g){s(b.urls,c[d].mediaurl),console.log("couldn't find file "+h+e+" but deleted it from json anyway")}}l(b)}a.length>0&&n(a)}})}else n(c.urls)}))})},l=function(a){var b=JSON.stringify(a),c=h+i;f.writeFile(c,b,function(a){console.log(a?a:"JSON saved to "+c)})},m=function(a){e(App.serverUrl,function(b,c){if(b||200!=c.statusCode)b&&a(b,null);else{var d=new DOMParser,e=d.parseFromString(c.body,"text/html"),f=e.body.children[0],g=f.querySelectorAll(".entry"),h={};h.urls=[];for(var i=0;i<g.length;i++)h.urls.push({mediaurl:g[i].innerHTML});a(null,h)}})},n=function(a){for(var b=0;b<a.length;b++){var c=a[b].mediaurl.split("/")[4];new FileDownloader(a[b].mediaurl,h+c,p,q,o)}},o=function(a){console.log("Download Error ",a)},p=function(a,b){var c=a+"mb / "+b+"mb",d=a/b*100;console.log(c+"  "+d+"%")},q=function(a,c){if(console.log(c),c&&"paused"!=c.message);else{if(c&&"paused"==c.message)return;b||(b={},b.urls=[]),b.urls.push({mediaurl:a.remoteUrl}),l(b),console.log(a)}},r=function(a,b,c){var d,e;a.length>b.length?(d=a,e=b):b.length>a.length?(d=b,e=a):(d=a,e=b);for(var f=a.slice(0),g=b.slice(0),h=0;h<d.length;h++)for(var i=0;i<e.length;i++){var j=d[h],k=e[i];if(j.mediaurl===k.mediaurl){s(f,j.mediaurl),s(g,j.mediaurl);break}}console.log("deleteIssuesArr = ",f),console.log("addIssuesArr = ",g),c(g,f)},s=function(a,b){for(var c=0;c<a.length;c++)a[c].mediaurl===b&&a.splice(c,1)},t=function(){};return{viewContentPath:c,viewControllerName:d,create:j,destroy:t}},ViewController=ViewController||function(){var a,b="./app-data/<path>.html",c="ViewController",d=function(b){a=b?b.previousViewControllerName:null},e=function(){};return{viewContentPath:b,viewControllerName:c,create:d,destroy:e}},Dialog=Dialog||function(a,b,c,d){function e(a){"confirm"===a.target.id?c(!0):"cancel"===a.target.id&&c(!1)}function f(a){"Pause"===a.target.innerHTML?(a.target.innerHTML="Resume",d(!0)):(a.target.innerHTML="Pause",d(!1))}function g(a){"indeterminate"===a?z.removeAttribute("value"):(z.value||z.setAttribute("value",a),isNaN(a)||(z.value=a))}function h(a){y.innerHTML=a}function i(a){t.innerHTML=a}function j(a){a.classList.contains("isVisible")?a.classList.remove("isVisible"):a.classList.add("isVisible")}function k(){document.body.removeChild(r)}var l=b&&b.confirmCopy?b.confirmCopy:"OK",m=b&&void 0!=b.showConfirm?b.showConfirm:!0,n=b&&b.cancelCopy?b.cancelCopy:"Cancel",o=b&&void 0!=b.showCancel?b.showCancel:!1,p=b&&b.progressCopy?b.progressCopy:"0%",q=b&&void 0!=b.showProgress?b.showProgress:!1,r=document.createElement("div");r.setAttribute("class","dialog");var s=document.createElement("div");s.setAttribute("class","dialogInner");var t=document.createElement("p");t.innerHTML=a;var u=document.createElement("div");u.setAttribute("class","buttonsBar");var v=document.createElement("button");v.addEventListener("click",e,!1),v.innerHTML=n,v.id="cancel",u.appendChild(v),o&&v.classList.add("isVisible");var w=document.createElement("button");w.id="confirm",w.innerHTML=l,w.addEventListener("click",e,!1),u.appendChild(w),m&&w.classList.add("isVisible");var x=document.createElement("div");x.setAttribute("class","progressArea");var y=document.createElement("div");y.setAttribute("class","dialogProgressCopy"),y.innerHTML=p;var z=document.createElement("progress");z.setAttribute("class","dialogProgress"),z.setAttribute("max","100"),z.setAttribute("value","0");var A=document.createElement("button");return A.setAttribute("class","progressResumePauseButton"),A.innerHTML="Pause",A.addEventListener("click",f,!1),x.appendChild(z),x.appendChild(y),x.appendChild(A),q&&x.classList.add("isVisible"),s.appendChild(t),s.appendChild(x),s.appendChild(u),r.appendChild(s),document.body.appendChild(r),{updateProgress:g,updateProgressMessage:h,updateMessage:i,toggleResumePauseButton:function(){j(A)},toggleConfirmButton:function(){j(w)},toggleCancelButton:function(){j(v)},toggleProgress:function(){j(x),j(A)},updateConfirmCopy:function(a){w.innerHTML=a},updateCancelCopy:function(a){v.innerHTML=a},hide:k}};