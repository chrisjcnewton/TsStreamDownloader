var App=App||function(){var a=require("is-online"),b=require("fs"),c=require("crypto"),d=(require("nw.gui"),"aes-256-ctr"),e="http://192.168.1.37/",f="/Users/chrisnewton/Movies/",g=[],h=function(){j(new DownloadViewController)},i=function(a,c){b.readFile(a,"utf8",function(a,b){if(a)c(a,null);else{var d=new DOMParser,e=d.parseFromString(b,"text/html"),f=e.body.children[0];c(null,f)}})},j=function(a,b,c){i(a.viewContentPath,function(d,e){if(d)console.log("Error loading viewContent");else{var f=c?c:{},h=document.querySelector(".viewContent");if(h){var i=g.pop();f.previousViewControllerName=i.viewControllerName,h.style.transform=b?"translateX("+window.innerWidth+"px)":"scale(0.8)",h.addEventListener("transitionend",function j(){document.body.removeChild(h),i.destroy(),i=null,h.removeEventListener("transitionend",j,!1)},!1),document.body.appendChild(e),b&&(e.style.zIndex="-1"),e.style.transform=b?"scale(0.8)":"translateX("+window.innerWidth+"px)",e.addEventListener("transitionend",function k(){g.push(a),a.create(f),e.removeEventListener("transitionend",k,!1)},!1),e.offsetWidth,e.style.transform=b?"scale(1.0)":"translateX(0px)"}else document.body.appendChild(e),g.push(a),a.create(f)}})},k=function(b){a(b)},l=function(a){var b=localStorage.getItem(a);if(""==b||void 0==b)return b;try{b=o(b)}catch(c){console.log("DECRYPT ERROR")}return b},m=function(a,b){var c=""==b?b:n(b);localStorage.setItem(a,c)},n=function(a){var b=c.createCipher(d,AppConstants.localEncryptionKey),e=b.update(a,"utf8","hex");return e+=b["final"]("hex")},o=function(a){var b=c.createDecipher(d,AppConstants.localEncryptionKey),e=b.update(a,"hex","utf8");return e+=b["final"]("utf8")},p=function(a,c){var d;b.exists(a,function(e){e?b.readFile(a,function(b,e){if(b)d={status:a+" : Error reading json from disk"},c(d,null);else{var f;try{f=JSON.parse(e),c(null,f)}catch(g){d={status:a+" : Error parsing json"},c(d,null)}}}):c(null,null)})};return window.addEventListener("load",h,!1),{serverUrl:e,downloadFolder:f,isNetworkConnected:k,startViewController:j,getItemFromStorage:l,setItemToStorage:m,readJsonFromDisk:p}}(),gui=require("nw.gui"),win=gui.Window.get(),menubar=new gui.Menu({type:"menubar"});"darwin"===process.platform;var fileMenu=new gui.Menu;fileMenu.append(new gui.MenuItem({type:"normal",label:"Check for new content",click:function(){gui.Window.get().close(!0)}})),fileMenu.append(new gui.MenuItem({type:"separator"})),fileMenu.append(new gui.MenuItem({type:"normal",label:"Exit",click:function(){gui.Window.get().close(!0)}})),menubar.append(new gui.MenuItem({label:"File",submenu:fileMenu})),win.menu=menubar;var FileDownloader=FileDownloader||function(a,b,c,d,e){function f(){a.targetPath=b;var f=a.mediaurl;l=m({method:"GET",uri:f,headers:{Range:"bytes="+q+"-"}}),l.pipe(k),l.on("response",function(c){console.log(c);var d=c.headers["content-type"];if(console.log(d),"Not Found"==c.statusMessage){var f={message:"Not Found"};return e(f,a),s=!0,n.unlink(b),void l.abort()}var g=c.headers["content-length"],k=c.headers["content-range"];!g&&k?h=parseInt(c.headers["content-range"].split("/")[1],10):g&&(h=parseInt(c.headers["content-length"],10)),console.log(h),i=0,j=h/o,isNaN(h)&&(r=!0,l.abort())}),l.on("data",function(b){if(t)u+=b;else{i+=b.length;var d=i/o,e=0===q?d:q/o+d,f=0===q?j:q/o+j;c(Math.floor(e),Math.floor(f),a.title)}}),l.on("end",function(){var b=null,c="File downloaded successfully";if(r)console.log("FileDownloader: File already Downloaded"),c="File already Downloaded";else{if(s)return;p?b={message:"paused"}:t&&(b={message:u},console.log(u))}d(a,c,b)}),l.on("error",function(b){console.log(b),e(b,a)})}function g(){p=!0,l.abort()}var h,i,j,k,l,m=require("request"),n=require("fs"),o=1048576,p=!1,q=0,r=!1,s=!1,t=!1,u="";return n.stat(b,function(a,c){a?(k=n.createWriteStream(b),f()):(q=c.size,k=n.createWriteStream(b,{flags:"a"}),f())}),console.log("url = "+a.mediaurl),{cancel:g}},UpnpSearch=UpnpSearch||void 0,VideoConverter=VideoConverter||function(a,b,c,d,e,f){var g=require("handbrake-js");g.spawn({input:a,output:b,preset:"Normal",width:1024,rate:25}).on("error",function(a){f(a)}).on("progress",function(a){console.log("Percent complete: %s, ETA: %s",a.percentComplete,a.eta),d(a)}).on("end",function(){}).on("complete",function(){e()})},DownloadViewController=DownloadViewController||function(){var a,b,c,d,e="./app-data/download.html",f="DownloadViewController",g=require("request"),h=require("fs"),i=require("nw.gui"),j=i.App.dataPath+"/",k="urls.json",l="/browse/index.jim?dir=/media/My%20Video/aaa_server",m=0,n=0,o=0,p=0,q=function(b){a=b?b.previousViewControllerName:null,c=document.querySelector("#mediaList");var d=document.querySelector("#ipAddress"),e=document.querySelector("#tsFolderLocation"),f=document.querySelector("#mp4FolderLocation"),g=document.querySelector("#startButton");d.value=localStorage.getItem("ipaddress"),e.value=localStorage.getItem("tsFolderPath"),f.value=localStorage.getItem("mp4FolderPath"),g.addEventListener("click",function(){localStorage.setItem("ipaddress",d.value),localStorage.setItem("tsFolderPath",e.value),localStorage.setItem("mp4FolderPath",f.value),App.serverUrl=d.value,App.downloadFolder=e.value,console.log("BOOM"),r()},!1)},r=function(){App.readJsonFromDisk(j+k,function(a,e){a?console.log(a.status):(e?b=e:(console.log("File does not exist"),b=null),t(function(a,e){if(a)console.log("Error Connecting to Server = "+a);else if(b){var f=b.urls,g=e.urls;z(f,g,function(a,e){if(0==a.length&&0==e.length)console.log("No Changes on Server"),c.innerHTML="No Changes on Server";else{if(e.length>0){console.log("deleteArray = ",e);for(var f=0;f<e.length;f++){var g=e[f].mediaurl.split("/")[4];try{h.unlinkSync(j+g),A(b.urls,e[f].mediaurl)}catch(i){A(b.urls,e[f].mediaurl),console.log("couldn't find file "+j+g+" but deleted it from json anyway")}}s(b)}a.length>0&&(m=a.length,d=a,u())}})}else m=e.urls.length,d=e.urls,u()}))})},s=function(a){var b=JSON.stringify(a),c=j+k;h.writeFile(c,b,function(a){console.log(a?a:"JSON saved to "+c)})},t=function(a){console.log(App.serverUrl+l),g(App.serverUrl+l,function(b,c){if(b||200!=c.statusCode)b&&(console.log(b),a(b,null));else{console.log(c.body);var d=new DOMParser,e=d.parseFromString(c.body,"text/html"),f=e.body,h=f.querySelectorAll("fieldset.cleft div.va.bf"),i={};i.urls=[];for(var j=h.length,k=0,l=0;l<h.length;l++){var m=h[l].querySelector("a.bf"),n=m.getAttribute("file"),o=m.getAttribute("type"),p=App.serverUrl+"browse/file.jim?file="+n+"&type="+o;console.log("fileUrl = "+p),g(p,function(b,c){if(b||200!=c.statusCode)b&&j--;else{k++;for(var e=d.parseFromString(c.body,"text/html"),f=e.body,g=f.querySelector("a").href,h=decodeURI(f.querySelector(".bmp.va").getAttribute("src").split("/")[4]),l="",m="",n=f.querySelectorAll("th"),o=0;o<n.length;o++){var p=n[o].innerHTML;"synopsis"==p.toLowerCase()&&(l=n[o].parentNode.children[1].innerHTML),"flags"==p.toLowerCase()&&(m=n[o].parentNode.children[1].innerHTML.substring(0,2))}i.urls.push({mediaurl:g,title:h,desc:l,definition:m}),k==j&&a(null,i)}})}console.log(i)}})},u=function(){console.log("noOfMediaFilesDownloaded ",n),console.log("totalMediaFilesToDownload ",m);for(var a=0;a<d.length;a++){var b=document.createElement("li");b.urlObj=d[a];var e=d[a].title,f=document.createElement("p");f.innerHTML=e,f.setAttribute("class","mediaLabel");var g=document.createElement("p");g.setAttribute("class","progLabel"),g.innerHTML="";var h=document.createElement("progress");h.max="100",h.value="0",b.appendChild(f),b.appendChild(g),b.appendChild(h),c.appendChild(b)}var e=d[n].title;v(d[n],App.downloadFolder+e,x,y,w)},v=function(a,b,c,d,e){new FileDownloader(a,b,c,d,e)},w=function(a,b){console.log("Download Error ",a);for(var d=0;d<c.children.length;d++)c.children[d].urlObj.title===b.title&&(c.children[d].children[1].innerHTML="File not found on server");m--},x=function(a,b,d){for(var e=a+"mb / "+b+"mb",f=a/b*100,g=0;g<c.children.length;g++)c.children[g].urlObj.title===d&&(c.children[g].children[1].innerHTML=e+"  "+Math.floor(f)+"%",c.children[g].children[2].value=f)},y=function(a,e,f){if(console.log(f),f&&"paused"!=f.message);else{if(f&&"paused"==f.message)return;b||(b={},b.urls=[]),b.urls.push({mediaurl:a.mediaurl,title:a.title,desc:a.desc,localFile:a.targetPath}),s(b),n++;for(var g=0;g<c.children.length;g++)c.children[g].urlObj.title===a.title&&(c.children[g].classList.add("dlComplete"),c.children[g].children[1].innerHTML=e);if(1===n)o=b.urls.length,B(b.urls[p].localFile,b.urls[p].localFile+".mp4");else{var h=d[n].title;v(d[n],App.downloadFolder+h,x,y,w)}}},z=function(a,b,c){var d,e;a.length>b.length?(d=a,e=b):b.length>a.length?(d=b,e=a):(d=a,e=b);for(var f=a.slice(0),g=b.slice(0),h=0;h<d.length;h++)for(var i=0;i<e.length;i++){var j=d[h],k=e[i];if(j.mediaurl===k.mediaurl){A(f,j.mediaurl),A(g,j.mediaurl);break}}console.log("deleteIssuesArr = ",f),console.log("addIssuesArr = ",g),c(g,f)},A=function(a,b){for(var c=0;c<a.length;c++)a[c].mediaurl===b&&a.splice(c,1)},B=function(a,b){new VideoConverter(a,b,null,D,E,C)},C=function(a){console.log("error = "+a)},D=function(a){console.log("converting file = "+a.percentComplete+"  "+a.eta)},E=function(){console.log("conversion Complete"),p++,1==p||B(b.urls[p].localFile,b.urls[p].localFile+".mp4")},F=function(){};return{viewContentPath:e,viewControllerName:f,create:q,destroy:F}},ViewController=ViewController||function(){var a,b="./app-data/<path>.html",c="ViewController",d=function(b){a=b?b.previousViewControllerName:null},e=function(){};return{viewContentPath:b,viewControllerName:c,create:d,destroy:e}},Dialog=Dialog||function(a,b,c,d){function e(a){"confirm"===a.target.id?c(!0):"cancel"===a.target.id&&c(!1)}function f(a){"Pause"===a.target.innerHTML?(a.target.innerHTML="Resume",d(!0)):(a.target.innerHTML="Pause",d(!1))}function g(a){"indeterminate"===a?z.removeAttribute("value"):(z.value||z.setAttribute("value",a),isNaN(a)||(z.value=a))}function h(a){y.innerHTML=a}function i(a){t.innerHTML=a}function j(a){a.classList.contains("isVisible")?a.classList.remove("isVisible"):a.classList.add("isVisible")}function k(){document.body.removeChild(r)}var l=b&&b.confirmCopy?b.confirmCopy:"OK",m=b&&void 0!=b.showConfirm?b.showConfirm:!0,n=b&&b.cancelCopy?b.cancelCopy:"Cancel",o=b&&void 0!=b.showCancel?b.showCancel:!1,p=b&&b.progressCopy?b.progressCopy:"0%",q=b&&void 0!=b.showProgress?b.showProgress:!1,r=document.createElement("div");r.setAttribute("class","dialog");var s=document.createElement("div");s.setAttribute("class","dialogInner");var t=document.createElement("p");t.innerHTML=a;var u=document.createElement("div");u.setAttribute("class","buttonsBar");var v=document.createElement("button");v.addEventListener("click",e,!1),v.innerHTML=n,v.id="cancel",u.appendChild(v),o&&v.classList.add("isVisible");var w=document.createElement("button");w.id="confirm",w.innerHTML=l,w.addEventListener("click",e,!1),u.appendChild(w),m&&w.classList.add("isVisible");var x=document.createElement("div");x.setAttribute("class","progressArea");var y=document.createElement("div");y.setAttribute("class","dialogProgressCopy"),y.innerHTML=p;var z=document.createElement("progress");z.setAttribute("class","dialogProgress"),z.setAttribute("max","100"),z.setAttribute("value","0");var A=document.createElement("button");return A.setAttribute("class","progressResumePauseButton"),A.innerHTML="Pause",A.addEventListener("click",f,!1),x.appendChild(z),x.appendChild(y),x.appendChild(A),q&&x.classList.add("isVisible"),s.appendChild(t),s.appendChild(x),s.appendChild(u),r.appendChild(s),document.body.appendChild(r),{updateProgress:g,updateProgressMessage:h,updateMessage:i,toggleResumePauseButton:function(){j(A)},toggleConfirmButton:function(){j(w)},toggleCancelButton:function(){j(v)},toggleProgress:function(){j(x),j(A)},updateConfirmCopy:function(a){w.innerHTML=a},updateCancelCopy:function(a){v.innerHTML=a},hide:k}};