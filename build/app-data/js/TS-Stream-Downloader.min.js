var App=App||function(){var a=require("is-online"),b=require("fs"),c=require("crypto"),d=(require("nw.gui"),"aes-256-ctr"),e="http://192.168.1.69/",f="/Users/chrisnewton/Movies/",g=[],h=function(){j(new DownloadViewController)},i=function(a,c){b.readFile(a,"utf8",function(a,b){if(a)c(a,null);else{var d=new DOMParser,e=d.parseFromString(b,"text/html"),f=e.body.children[0];c(null,f)}})},j=function(a,b,c){i(a.viewContentPath,function(d,e){if(d)console.log("Error loading viewContent");else{var f=c?c:{},h=document.querySelector(".viewContent");if(h){var i=g.pop();f.previousViewControllerName=i.viewControllerName,h.style.transform=b?"translateX("+window.innerWidth+"px)":"scale(0.8)",h.addEventListener("transitionend",function j(){document.body.removeChild(h),i.destroy(),i=null,h.removeEventListener("transitionend",j,!1)},!1),document.body.appendChild(e),b&&(e.style.zIndex="-1"),e.style.transform=b?"scale(0.8)":"translateX("+window.innerWidth+"px)",e.addEventListener("transitionend",function k(){g.push(a),a.create(f),e.removeEventListener("transitionend",k,!1)},!1),e.offsetWidth,e.style.transform=b?"scale(1.0)":"translateX(0px)"}else document.body.appendChild(e),g.push(a),a.create(f)}})},k=function(b){a(b)},l=function(a){var b=localStorage.getItem(a);if(""==b||void 0==b)return b;try{b=o(b)}catch(c){console.log("DECRYPT ERROR")}return b},m=function(a,b){var c=""==b?b:n(b);localStorage.setItem(a,c)},n=function(a){var b=c.createCipher(d,AppConstants.localEncryptionKey),e=b.update(a,"utf8","hex");return e+=b["final"]("hex")},o=function(a){var b=c.createDecipher(d,AppConstants.localEncryptionKey),e=b.update(a,"hex","utf8");return e+=b["final"]("utf8")},p=function(a,c){var d;b.exists(a,function(e){e?b.readFile(a,function(b,e){if(b)d={status:a+" : Error reading json from disk"},c(d,null);else{var f;try{f=JSON.parse(e),c(null,f)}catch(g){d={status:a+" : Error parsing json"},c(d,null)}}}):c(null,null)})};return window.addEventListener("load",h,!1),{serverUrl:e,downloadFolder:f,isNetworkConnected:k,startViewController:j,getItemFromStorage:l,setItemToStorage:m,readJsonFromDisk:p}}(),gui=require("nw.gui"),win=gui.Window.get(),menubar=new gui.Menu({type:"menubar"});"darwin"===process.platform;var fileMenu=new gui.Menu;fileMenu.append(new gui.MenuItem({type:"normal",label:"Check for new content",click:function(){gui.Window.get().close(!0)}})),fileMenu.append(new gui.MenuItem({type:"separator"})),fileMenu.append(new gui.MenuItem({type:"normal",label:"Exit",click:function(){gui.Window.get().close(!0)}})),menubar.append(new gui.MenuItem({label:"File",submenu:fileMenu})),win.menu=menubar;var FileDownloader=FileDownloader||function(a,b,c,d,e){function f(){var f=a.mediaurl;l=m({method:"GET",uri:f,headers:{Range:"bytes="+q+"-"}}),l.pipe(k),l.on("response",function(c){console.log(c);var d=c.headers["content-type"];if(console.log(d),"Not Found"==c.statusMessage){var f={message:"Not Found"};return e(f,a),s=!0,n.unlink(b),void l.abort()}var g=c.headers["content-length"],k=c.headers["content-range"];!g&&k?h=parseInt(c.headers["content-range"].split("/")[1],10):g&&(h=parseInt(c.headers["content-length"],10)),console.log(h),i=0,j=h/o,isNaN(h)&&(r=!0,l.abort())}),l.on("data",function(b){if(t)u+=b;else{i+=b.length;var d=i/o,e=0===q?d:q/o+d,f=0===q?j:q/o+j;c(Math.floor(e),Math.floor(f),a.title)}}),l.on("end",function(){var b=null,c="File downloaded successfully";if(r)console.log("FileDownloader: File already Downloaded"),c="File already Downloaded";else{if(s)return;p?b={message:"paused"}:t&&(b={message:u},console.log(u))}d(a,c,b)}),l.on("error",function(b){console.log(b),e(b,a)})}function g(){p=!0,l.abort()}var h,i,j,k,l,m=require("request"),n=require("fs"),o=1048576,p=!1,q=0,r=!1,s=!1,t=!1,u="";return n.stat(b,function(a,c){a?(k=n.createWriteStream(b),f()):(q=c.size,k=n.createWriteStream(b,{flags:"a"}),f())}),console.log("url = "+a.mediaurl),{cancel:g}},VideoConverter=VideoConverter||function(a,b,c,d,e,f){var g=require("handbrake-js");g.spawn({input:a,output:b,preset:"Normal"}).on("error",function(a){f(a)}).on("progress",function(a){console.log("Percent complete: %s, ETA: %s",a.percentComplete,a.eta),d(a)}).on("end",function(){}).on("complete",function(){e()})},DownloadViewController=DownloadViewController||function(){var a,b,c="./app-data/download.html",d="DownloadViewController",e=(require("request"),require("fs"),require("nw.gui")),f=(e.App.dataPath+"/",function(c){a=c?c.previousViewControllerName:null,b=document.querySelector("#mediaList"),g()}),g=function(){new VideoConverter(App.downloadFolder+"Little Fockers_20150107_2313.ts",App.downloadFolder+"Little Fockers_20150107_2313_normal.mp4",null,i,j,h)},h=function(a){console.log("error = "+a)},i=function(a){console.log("converting file = "+a.percentComplete+"  "+a.eta)},j=function(){console.log("conversion Complete")},k=function(){};return{viewContentPath:c,viewControllerName:d,create:f,destroy:k}},ViewController=ViewController||function(){var a,b="./app-data/<path>.html",c="ViewController",d=function(b){a=b?b.previousViewControllerName:null},e=function(){};return{viewContentPath:b,viewControllerName:c,create:d,destroy:e}},Dialog=Dialog||function(a,b,c,d){function e(a){"confirm"===a.target.id?c(!0):"cancel"===a.target.id&&c(!1)}function f(a){"Pause"===a.target.innerHTML?(a.target.innerHTML="Resume",d(!0)):(a.target.innerHTML="Pause",d(!1))}function g(a){"indeterminate"===a?z.removeAttribute("value"):(z.value||z.setAttribute("value",a),isNaN(a)||(z.value=a))}function h(a){y.innerHTML=a}function i(a){t.innerHTML=a}function j(a){a.classList.contains("isVisible")?a.classList.remove("isVisible"):a.classList.add("isVisible")}function k(){document.body.removeChild(r)}var l=b&&b.confirmCopy?b.confirmCopy:"OK",m=b&&void 0!=b.showConfirm?b.showConfirm:!0,n=b&&b.cancelCopy?b.cancelCopy:"Cancel",o=b&&void 0!=b.showCancel?b.showCancel:!1,p=b&&b.progressCopy?b.progressCopy:"0%",q=b&&void 0!=b.showProgress?b.showProgress:!1,r=document.createElement("div");r.setAttribute("class","dialog");var s=document.createElement("div");s.setAttribute("class","dialogInner");var t=document.createElement("p");t.innerHTML=a;var u=document.createElement("div");u.setAttribute("class","buttonsBar");var v=document.createElement("button");v.addEventListener("click",e,!1),v.innerHTML=n,v.id="cancel",u.appendChild(v),o&&v.classList.add("isVisible");var w=document.createElement("button");w.id="confirm",w.innerHTML=l,w.addEventListener("click",e,!1),u.appendChild(w),m&&w.classList.add("isVisible");var x=document.createElement("div");x.setAttribute("class","progressArea");var y=document.createElement("div");y.setAttribute("class","dialogProgressCopy"),y.innerHTML=p;var z=document.createElement("progress");z.setAttribute("class","dialogProgress"),z.setAttribute("max","100"),z.setAttribute("value","0");var A=document.createElement("button");return A.setAttribute("class","progressResumePauseButton"),A.innerHTML="Pause",A.addEventListener("click",f,!1),x.appendChild(z),x.appendChild(y),x.appendChild(A),q&&x.classList.add("isVisible"),s.appendChild(t),s.appendChild(x),s.appendChild(u),r.appendChild(s),document.body.appendChild(r),{updateProgress:g,updateProgressMessage:h,updateMessage:i,toggleResumePauseButton:function(){j(A)},toggleConfirmButton:function(){j(w)},toggleCancelButton:function(){j(v)},toggleProgress:function(){j(x),j(A)},updateConfirmCopy:function(a){w.innerHTML=a},updateCancelCopy:function(a){v.innerHTML=a},hide:k}};